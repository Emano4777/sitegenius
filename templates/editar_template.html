<!DOCTYPE html>
<html lang="pt-br">
<head>

    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
<script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <link rel="icon" href="https://res.cloudinary.com/dzpvczzab/image/upload/v1743096113/ChatGPT_Image_27_de_mar._de_2025_14_18_50_vh4wix.png" type="image/png">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/grapesjs@0.17.26/dist/grapes.min.js"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage@1.0.2"></script>

    <title>Editor Visual</title>

    

    <style>
       body, html {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
}

#editor {
    height: 100vh;
    width: 100%;
    margin-top: 70px; /* espa√ßo para a barra fixa */
}

#tutorial-balao {
    position: absolute;
    z-index: 999999;
    background-color: #1e1e1e;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    max-width: 300px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    border: 2px solid #f0c040;
    font-family: 'Poppins', sans-serif;
}
#tutorial-balao button {
    margin-top: 10px;
    padding: 8px 16px;
    background: #f0c040;
    color: black;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
.meu-tutorial {
    background-color: #1e1e1e;
    color: #fff;
    border: 2px solid #f0c040;
    border-radius: 8px;
    padding: 10px;
}

.introjs-helperLayer {
    background-color: rgba(0, 0, 0, 0.6) !important;
    box-shadow: 0 0 0 3px #f0c040 !important;
    border-radius: 10px !important;
}
/* Barra superior */
#top-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #1e2a38;
    color: white;
    padding: 10px 20px;
    z-index: 9999;
    display: flex;
    gap: 10px;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Inputs e bot√µes da barra */
#top-bar input, #top-bar button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
}

/* Campo de sele√ß√£o de p√°gina */
#top-bar input {
    width: 220px;
    background-color: #f5f5f5;
    color: #333;
}

/* Bot√µes padr√£o */
#top-bar button {
    background-color: #1e2a38;
    color: white;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
}

#top-bar button:hover {
    background-color: #e68900;
    color: white;
    transform: scale(1.03);
}

/* Bot√£o Salvar */
#salvar-btn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background-color: #1e2a38;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#salvar-btn:hover {
    background-color: #e68900;
}

/* Bot√£o Nova P√°gina */
#nova-pagina-btn {
    position: fixed;
    bottom: 70px;
    left: 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#nova-pagina-btn:hover {
    background-color: #388E3C;
}

#voltar-site-btn {
    background-color: #777;
    color: white;
    font-weight: bold;
}

#voltar-site-btn:hover {
    background-color: #555;
}

    </style>
</head>
    
<link href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.8/css/grapes.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.8/grapes.min.js"></script>
<body>

    <div id="editor" data-intro="üéØ Aqui √© onde voc√™ monta o seu site! Arraste blocos da esquerda e solte aqui. Depois, √© s√≥ clicar nos textos ou imagens para editar."></div>

    <div id="top-bar">
        <button id="nova-pagina-btn" data-intro="üìÑ Clique aqui para criar uma nova p√°gina para o seu site. Voc√™ pode alternar entre elas depois.">
            <i class="fas fa-file-circle-plus"></i> Nova P√°gina
        </button>

        <button id="voltar-site-btn" data-intro="üîô Volta para a √°rea onde est√£o todos os seus templates salvos.">
            <i class="fas fa-arrow-left"></i> Voltar para Meus Templates
        </button>

        <button onclick="forcarTutorial()" id="btn-tutorial" data-intro="‚ùì Clique aqui para iniciar este tutorial interativo novamente.">
            <i class="fas fa-circle-question"></i> Tutorial de como utilizar o editor
        </button>


        <button id="reset-dicas" title="Reexibir as dicas de imagem e texto">
            <i class="fas fa-sync-alt"></i> Reexibir Dicas
          </button>
          
        

        {% if premium_level in ['master', 'moderado', 'essential'] %}
        <input id="promptInput" placeholder="Descreva seu site..." style="width: 250px;" />
        <button id="gerarIA" class="btn" style="background-color: #4CAF50;">
            <i class="fas fa-robot"></i> Gerar com IA
        </button>
        {% endif %}

        
        <input id="input-pagina" list="paginas-disponiveis" placeholder="Digite ou selecione uma p√°gina"
        data-intro="üìÅ Aqui voc√™ escolhe ou digita o nome da p√°gina que quer editar.">
        <datalist id="paginas-disponiveis"></datalist>
    
        <button id="confirmar-troca" data-intro="üöÄ Depois de escolher uma p√°gina, clique aqui para acess√°-la.">
            <i class="fas fa-right-to-bracket"></i> Ir para p√°gina
        </button>
        
    
        <button id="salvar-btn" onclick="salvarTemplate()" data-intro="üíæ Clique aqui para salvar todas as altera√ß√µes feitas na p√°gina atual.">
            <i class="fas fa-save"></i> Salvar
        </button>
        
    </div>
    <script>
        const PREMIUM_LEVEL = "{{ premium_level }}";
        console.log("Nivel:", PREMIUM_LEVEL);
    </script>
    
    <script>
        
        const TEMPLATE_ID = "{{ template_id }}";
        const PAGE_NAME = "{{ page_name }}";
        
        console.log("TEMPLATE_ID:", TEMPLATE_ID);
    </script>
    <script>
        console.log("üß† Premium Level recebido:", "{{ premium_level }}");
    </script>
    

    <script>
        const IS_PREMIUM = "{{ is_premium }}" === "true";
        console.log("IS_PREMIUM:", IS_PREMIUM);
      </script>
      
    <script id="template-content" type="application/json">
        {{ html_atual | tojson | safe }}
    </script>
    <script>
function iniciarTutorial() {
    localStorage.removeItem('tutorial_feito');

    const mostrarMensagemFinal = () => {
        requestAnimationFrame(() => {
            setTimeout(() => {
                mostrarModalAviso(`
                    <div style="text-align:left">
                        üß† <strong>Quer aprender mais?</strong><br><br>
                        üëâ Acesse <a href="/tutorial" target="_blank" style="color:#f0c040; font-weight:bold;">/tutorial</a> para ver v√≠deos explicativos e exemplos prontos.<br><br>
                        üí¨ Em caso de d√∫vidas, acione o <strong>suporte</strong> pelo bot√£o no rodap√© do site.<br><br>
                        ‚úÖ Bom uso do editor!
                    </div>
                `);
            }, 300);
        });
    };

    introJs().setOptions({
        nextLabel: 'Pr√≥ximo',
        prevLabel: 'Voltar',
        doneLabel: 'Finalizar',
        skipLabel: 'Pular',
        tooltipClass: 'meu-tutorial',
        highlightClass: 'destacado'
    })
    .oncomplete(() => {
        localStorage.setItem('tutorial_feito', 'true');
        mostrarMensagemFinal(); // agora garante que o modal aparece
    })
    .onexit(() => {
        localStorage.setItem('tutorial_feito', 'true');
        mostrarMensagemFinal();
    })
    .start();
}


function mostrarModalAviso(texto) {
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.background = '#fff';
    modal.style.color = '#333';
    modal.style.borderRadius = '10px';
    modal.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
    modal.style.padding = '20px 30px';
    modal.style.zIndex = '10001';
    modal.style.textAlign = 'center';
    modal.style.fontSize = '16px';
    modal.innerHTML = `
        <div style="margin-bottom: 20px;"><i class="fas fa-info-circle" style="color:#f0c040;"></i> ${texto}</div>
        <button onclick="this.parentElement.remove()" style="background-color:#1e2a38; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Fechar</button>
    `;
    document.body.appendChild(modal);
}


function forcarTutorial() {
    introJs().setOptions({
        nextLabel: 'Pr√≥ximo',
        prevLabel: 'Voltar',
        doneLabel: 'Finalizar',
        skipLabel: 'Pular',
        tooltipClass: 'meu-tutorial',
        highlightClass: 'destacado'
    })
    .oncomplete(() => {
        setTimeout(() => {
            mostrarModalAviso(`
    <div style="text-align:left">
        üß† <strong>Quer aprender mais?</strong><br><br>
        üì∫ Veja v√≠deos explicativos e exemplos prontos clicando no bot√£o abaixo:<br><br>
        <button onclick="window.open('/tutorial', '_blank')" style="background:#f0c040; border:none; color:#000; font-weight:bold; padding:10px 16px; border-radius:6px; cursor:pointer;">
            Acessar Tutorial em V√≠deo
        </button><br><br>
        üí¨ Em caso de d√∫vidas, acione o <strong>suporte</strong> pelo bot√£o no canto inferior esquerdo.<br><br>
        ‚úÖ Bom uso do editor!
    </div>
`);

        }, 1000);
    })
    .onexit(() => {
        setTimeout(() => {
            mostrarModalAviso(`
    <div style="text-align:left">
        üß† <strong>Quer aprender mais?</strong><br><br>
        üì∫ Veja v√≠deos explicativos e exemplos prontos clicando no bot√£o abaixo:<br><br>
        <button onclick="window.open('/tutorial', '_blank')" style="background:#f0c040; border:none; color:#000; font-weight:bold; padding:10px 16px; border-radius:6px; cursor:pointer;">
            Acessar Tutorial em V√≠deo
        </button><br><br>
        üí¨ Em caso de d√∫vidas, acione o <strong>suporte</strong> pelo bot√£o no canto inferior esquerdo.<br><br>
        ‚úÖ Bom uso do editor!
    </div>
`);
        }, 1000);
    })
    .start();
}

        </script>
    <script>
        let editor;
        document.addEventListener("DOMContentLoaded", function () {


            const nivel = "{{ premium_level }}".toLowerCase().trim();

    // Se o n√≠vel n√£o for master, remove os elementos manualmente
    if (!["master", "moderado", "essential"].includes(nivel)) {
    document.getElementById("promptInput")?.remove();
    document.getElementById("gerarIA")?.remove();
}

            fetch('/verificar-sessao', {
    credentials: 'include'
    })
    .then(res => {
        if (res.status === 401) {
            alert("Sua sess√£o expirou. Redirecionando para o login...");
            window.location.href = "/login";
        }
});    
document.getElementById("voltar-site-btn").addEventListener("click", function () {
    window.location.href = "/meu-site";
});





        document.getElementById("input-pagina").value = "{{ page_name }}";

        const rawHtml = document.getElementById("template-content").textContent;
        const templateHTML = JSON.parse(rawHtml);

        editor = grapesjs.init({
            container: "#editor",
            height: "100%",
            width: "auto",
            storageManager: false,
            fromElement: false,
            plugins: ["gjs-preset-webpage"],
            pluginsOpts: { "gjs-preset-webpage": {} }
        });
        
       
         

        // ‚úÖ Carrega o template salvo no banco
        const parser = new DOMParser();
        const doc = parser.parseFromString(templateHTML, "text/html");

        const bodyContent = doc.body?.innerHTML || '';
        const styleContent = Array.from(doc.head?.querySelectorAll('style') || [])
            .map(style => style.innerHTML)
            .join("\n");
       
           
        editor.setComponents(bodyContent);
        editor.setStyle(styleContent);
     
        editor.on("component:selected", (model) => {
    if (!IS_PREMIUM && model.get("tagName") === "img") {
        const resposta = confirm("Voc√™ precisa ser um usu√°rio Premium para editar imagens ou liberar o servi√ßo avulso.\n\nClique em OK para saber mais na p√°gina de pre√ßos.");
        if (resposta) {
            window.location.href = "/preco";
        }
        editor.select(null); // deseleciona o componente
    }
});


function aguardarTraitsEIniciarTutorial(tag) {
    const observer = new MutationObserver((mutations, obs) => {
        const traitsEl = document.querySelector('.gjs-trt-traits');
        if (!traitsEl) return;

        if (traitsEl.offsetHeight > 0 && traitsEl.innerText.trim().length > 0) {
            obs.disconnect();

            introJs().setOptions({
                steps: [
                    {
                        element: traitsEl,
                        intro: tag === 'img'
                            ? 'üñº Aqui voc√™ edita a <strong>URL da imagem</strong>, <strong>largura</strong>, <strong>altura</strong> etc.'
                            : '‚úçÔ∏è Aqui voc√™ edita <strong>texto, cor, tamanho de fonte</strong> e mais.',
                        position: 'right'
                    }
                ],
                tooltipClass: 'meu-tutorial',
                highlightClass: 'destacado',
                showButtons: true
            }).start();
        }
    });

    observer.observe(document.body, { childList: true, subtree: true });
}

editor.on('component:selected', (model) => {
    const tag = model.get('tagName');
    if (!['img', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span'].includes(tag)) return;

    const isImage = tag === 'img';
    const storageKey = isImage ? 'dica_img_vista' : 'dica_txt_vista';

    // S√≥ mostra se ainda n√£o foi vista
    if (localStorage.getItem(storageKey)) return;

    // Remove o bal√£o anterior se j√° existir
    document.getElementById('tutorial-balao')?.remove();

    const iframe = editor.Canvas.getFrameEl(); // iframe do canvas
    const el = model.view?.el;
    if (!iframe || !el) return;

    // Calcula posi√ß√£o do elemento clicado
    const rect = el.getBoundingClientRect();
    const iframeRect = iframe.getBoundingClientRect();
    const top = iframeRect.top + rect.top + window.scrollY;
    const left = iframeRect.left + rect.left + window.scrollX;

    const explicacao = isImage ? `
        <strong><i class="fas fa-image"></i> Imagem selecionada</strong><br><br>
        üß≠ No menu da direita, voc√™ pode mudar o estilo da imagem:<br><br>
        <i class="fas fa-cogs"></i> <b>General:</b> posi√ß√£o, visibilidade<br>
        <i class="fas fa-expand-arrows-alt"></i> <b>Flex:</b> alinhamento se o container usar esse layout<br>
        <i class="fas fa-ruler-combined"></i> <b>Dimension:</b> largura, altura, margens<br>
        <i class="fas fa-paint-brush"></i> <b>Decorations:</b> bordas, fundo, sombra<br>
        <i class="fas fa-tools"></i> <b>Extra:</b> c√≥digo, ID, classes<br><br>
        ‚úÖ Clique nos menus para experimentar!
    ` : `
        <strong><i class="fas fa-font"></i> Texto selecionado</strong><br><br>
        üß≠ No menu da direita, voc√™ pode mudar o estilo do texto:<br><br>
        <i class="fas fa-font"></i> <b>Typography:</b> fonte, cor, tamanho, estilo<br>
        <i class="fas fa-ruler-combined"></i> <b>Dimension:</b> largura, espa√ßamentos<br>
        <i class="fas fa-cogs"></i> <b>General:</b> visibilidade, posicionamento<br>
        <i class="fas fa-paint-brush"></i> <b>Decorations:</b> borda, sombra, fundo<br>
        <i class="fas fa-tools"></i> <b>Extra:</b> ID, classes e atributos<br><br>
        ‚úÖ Explore os estilos pra ver o efeito na hora!
    `;

    const balao = document.createElement('div');
    balao.id = 'tutorial-balao';
    balao.style.position = 'absolute';
    balao.style.top = `${top}px`;
    balao.style.left = `${left}px`;
    balao.style.background = '#1e1e1e';
    balao.style.color = '#fff';
    balao.style.border = '2px solid #f0c040';
    balao.style.borderRadius = '10px';
    balao.style.padding = '15px';
    balao.style.zIndex = '10000';
    balao.style.maxWidth = '300px';
    balao.style.fontSize = '14px';
    balao.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
    balao.innerHTML = `
        <div style="margin-bottom: 10px;">${explicacao}</div>
        <button id="tutorial-ok" style="background:#f0c040; border:none; padding:8px 12px; border-radius:5px; font-weight:bold; cursor:pointer;">Entendi</button>
    `;
    document.body.appendChild(balao);

    document.getElementById('tutorial-ok').addEventListener('click', () => {
        balao.remove();
        localStorage.setItem(storageKey, 'true');

        mostrarModalAviso("Essa dica n√£o ser√° exibida novamente, a n√£o ser que voc√™ clique no bot√£o reexibir dicas no menu superior.");

        // Destaca o painel de traits
        const traitsPanel = document.querySelector('.gjs-pn-views-container .gjs-pn-panel');
        if (traitsPanel) {
            traitsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            traitsPanel.style.boxShadow = '0 0 10px 2px #f0c040';
            setTimeout(() => {
                traitsPanel.style.boxShadow = 'none';
            }, 3000);
        }
    });
});




            editor.on("component:selected", (model) => {
    if (model.is("link")) {
        editor.Panels.addButton("options", {
            id: "edit-link",
            className: "fa fa-link",
            command: "edit-link",
            attributes: { title: "Editar Link" }
        });
    }
});


editor.on("component:selected", (model) => {
    if (model && model.get('tagName') === 'form') {
        const traits = model.get('traits').map(trait => trait.name);
        
        // Adiciona somente se ainda n√£o estiver l√°
        if (!traits.includes('action')) {
            model.addTrait([
                {
                    type: 'text',
                    label: 'E-mail de recebimento (FormSubmit)',
                    name: 'action',
                    placeholder: 'https://formsubmit.co/seuemail@exemplo.com'
                },
                {
                    type: 'text',
                    label: 'M√©todo',
                    name: 'method',
                    placeholder: 'POST'
                }
            ]);
        }
    }
});



// Componente customizado: Bot√£o Navega√ß√£o Interna
editor.BlockManager.add('botao-navegacao', {
    label: '<i class="fas fa-link"></i> Ir para P√°gina',
    category: 'Navega√ß√£o',
    content: {
        type: 'botao-navegacao',
        content: 'Ir para Sobre',
        attributes: { class: 'btn' },
        pageTarget: 'sobre' // default
    }
});

// Tipo do componente
editor.DomComponents.addType('botao-navegacao', {
    model: {
        defaults: {
            tagName: 'a',
            attributes: { href: '/template/sobre' },
            pageTarget: 'sobre',
            content: 'Ir para Sobre',
            droppable: false,
            traits: [
                {
                    type: 'text',
                    label: 'Texto',
                    name: 'content'
                },
                {
                    type: 'text',
                    label: 'P√°gina Destino',
                    name: 'pageTarget'
                }
            ]
        },

        init() {
            this.on('change:pageTarget', this.updateHref);
            this.on('change:content', this.updateContent);
        },

        updateHref() {
            const page = this.get('pageTarget');
            this.addAttributes({ href: `/template/${page}` });
        },

        updateContent() {
            const text = this.get('content');
            this.set('content', text);
        }
    }
});


editor.on('load', () => {


    setTimeout(() => {
        const blocosEl = document.querySelector('.gjs-blocks-categories');
        if (blocosEl) {
            blocosEl.setAttribute('data-intro', 'üß± Esses s√£o os blocos dispon√≠veis. Clique e arraste um deles para o centro da tela.');
            blocosEl.setAttribute('data-step', '1');
        }

        const editorEl = document.getElementById('editor');
        if (editorEl) {
            editorEl.setAttribute('data-intro', 'üéØ Aqui √© onde voc√™ monta seu site. Solte os blocos aqui, e clique nos elementos para editar textos, imagens, bot√µes e tudo mais.');
            editorEl.setAttribute('data-step', '2');
        }

        if (!localStorage.getItem('tutorial_feito')) {
            iniciarTutorial(); // ‚úÖ Tutorial autom√°tico s√≥ se nunca foi feito
        }
    }, 800);

    
    const canvasDoc = editor.Canvas.getDocument();
     
    canvasDoc.addEventListener('click', function (e) {
        const target = e.target;
        if (target.tagName === 'A' && target.getAttribute('href')) {
            const href = target.getAttribute('href');

            if (href.startsWith('/template/')) {
                e.preventDefault(); // Impede o link de sair do editor

                const novaPagina = href.split('/template/')[1];

                fetch(`${window.location.origin}/pagina-existe/{{ template_id }}/${novaPagina}`, {
                    method: 'GET',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.existe) {
                        window.location.href = `/editar-template/{{ template_id }}/${novaPagina}`;
                    } else {
                        alert("Essa p√°gina ainda n√£o existe. Crie com o bot√£o 'Nova P√°gina'.");
                    }
                });
            }
        }
    });
});


   fetch(`/listar-paginas/{{ template_id }}`)
        .then(res => res.json())
        .then(paginas => {
            const lista = document.getElementById('paginas-disponiveis');
            paginas.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                lista.appendChild(option);
            });
        });

    document.getElementById("confirmar-troca").addEventListener("click", function () {
        const novaPagina = document.getElementById("input-pagina").value;
        if (!novaPagina) {
            alert("Escolha uma p√°gina!");
            return;
        }

        fetch(`${window.location.origin}/pagina-existe/{{ template_id }}/${novaPagina}`, {
        method: 'GET',
        credentials: 'include' // Adiciona os cookies da sess√£o
    })
    .then(res => res.json())
    .then(data => {
        if (data.existe) {
            window.location.href = `/editar-template/{{ template_id }}/${novaPagina}`;
        } else {
            alert("Essa p√°gina ainda n√£o existe. Crie com o bot√£o 'Nova P√°gina'.");
        }
    })
    .catch(err => alert("Erro ao verificar a p√°gina."));
});


editor.Commands.add("edit-link", {
    run(editor, sender) {
        sender && sender.set("active", false);
        const selected = editor.getSelected();
        if (selected && selected.is("link")) {
            const newHref = prompt("Digite o novo link:", selected.getAttributes().href);
            if (newHref !== null) {
                selected.addAttributes({ href: newHref });
            }
        }
    }
});


document.getElementById("nova-pagina-btn").addEventListener("click", function () {
    const nomePagina = prompt("Digite o nome da nova p√°gina:");

    if (!nomePagina) {
        alert("Nome inv√°lido!");
        return;
    }

    fetch(`${window.location.origin}/adicionar-pagina/{{ template_id }}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ page_name: nomePagina, html: '<h1>Novo Conte√∫do</h1>', css: '' })
})
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        // Redireciona para a nova p√°gina no editor
        window.location.href = `/editar-template/{{ template_id }}/${nomePagina}`;
    })
    .catch(error => alert("Erro ao criar a nova p√°gina."));
});

       
window.salvarTemplate = function () {
    const html = editor.getHtml();
    const css = editor.getCss();

    const currentPage = document.getElementById("input-pagina").value || "{{ page_name }}";
    const templateId = "{{ template_id }}";

    const url = `${window.location.origin}/editar-template/${templateId}/${currentPage}`;

    console.log("Salvando p√°gina:", currentPage, "na URL:", url);

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // importante manter isso para enviar cookies
        body: JSON.stringify({ html: html, css: css })
    })
    .then(response => {
        console.log("Status da resposta:", response.status);
        if (response.status === 401) {
            alert("Sess√£o expirada. Fa√ßa login novamente.");
            window.location.href = "/login"; // ajuste se sua rota for diferente
            return;
        }

        if (!response.ok) {
            return response.text().then(text => { throw new Error(text); });
        }

        return response.json();
    })
    .then(data => {
        if (data && data.message) {
            alert(data.message);
        }
    })
    .catch(async error => {
    const response = error.response || error;
    const text = await (response.text?.() || "Erro desconhecido");
    console.error("Erro ao salvar:", text);
    alert("Erro ao salvar:\n" + text);
});
};
});


document.getElementById("reset-dicas").addEventListener("click", () => {
    const confirmar = confirm("Tem certeza que deseja reexibir as dicas de imagem e texto? Elas v√£o aparecer novamente ao clicar nos elementos.");
    if (!confirmar) return;

    localStorage.removeItem("dica_img_vista");
    localStorage.removeItem("dica_txt_vista");

    mostrarModalAviso("As dicas ser√£o exibidas novamente ao clicar em imagens e textos.");
});


document.getElementById("gerarIA")?.addEventListener("click", async () => {
    const prompt = document.getElementById("promptInput").value;

    if (!prompt.trim()) {
        alert("Digite uma descri√ß√£o para gerar o site com IA.");
        return;
    }

    const confirmar = confirm("‚ö†Ô∏è Isso ir√° sobrescrever completamente o conte√∫do atual com o que a IA gerar. Deseja continuar?");
    if (!confirmar) return;

    const res = await fetch("/gerar-site", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
    });

    const data = await res.json();

    if (res.status === 403) {
        alert(data.error);

        // Mostra alerta de uso esgotado por tipo
        if (data.error.includes("1 vez")) {
            alert("Como seu usu√°rio √© Essential, voc√™ s√≥ pode usar a IA uma vez. O bot√£o ser√° desabilitado.");
        } else if (data.error.includes("8 vezes")) {
            alert("Como seu usu√°rio √© Moderado, voc√™ j√° usou as 8 vezes dispon√≠veis. O bot√£o ser√° desabilitado.");
        }

        document.getElementById("gerarIA").disabled = true;
        document.getElementById("gerarIA").style.display = "none";
        return;
    }

    if (editor) {
        const dom = editor.DomComponents;
        const css = editor.CssComposer;

        dom.clear();
        css.clear();

        editor.setComponents(data.html || '');
        editor.setStyle(data.css || '');
    }

    // üî• Salva automaticamente no banco ap√≥s gerar
    salvarTemplate();
});

    </script>


<div id="modal-ajuda" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; color:#333; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.3); padding:30px; max-width:600px; z-index:99999;">
    <h2>Tutorial do Editor Visual</h2>
    <ul>
        <li>üî≤ <strong>Blocos</strong>: Arraste da esquerda para o centro.</li>
        <li>‚úèÔ∏è <strong>Edi√ß√£o</strong>: Clique nos textos ou imagens para editar.</li>
        <li>üíæ <strong>Salvar</strong>: Use o bot√£o "Salvar" no canto inferior esquerdo.</li>
        <li>‚ûï <strong>Nova P√°gina</strong>: Crie outra p√°gina clicando em "Nova P√°gina".</li>
        <li>üìÑ <strong>Ir para P√°gina</strong>: Use o campo e bot√£o para trocar de p√°gina.</li>
        <li>üì® <strong>Formul√°rios</strong>: Clique neles para editar o destino de envio.</li>
    </ul>
    <button onclick="document.getElementById('modal-ajuda').style.display='none'" style="margin-top:20px; background:#e68900; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">Fechar</button>
</div>

</body>
</html>
